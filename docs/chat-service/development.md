# Руководство по разработке Chat Service

## Начало работы

### Требования
- Go 1.19 или выше
- MongoDB 4.4 или выше
- Redis 6.0 или выше
- Make (опционально)

### Установка зависимостей
```bash
# Установка зависимостей Go
go mod download

# Установка инструментов разработки
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
go install github.com/go-delve/delve/cmd/dlv@latest
```

### Настройка окружения разработки
1. Создайте файл `.env` в корне проекта:
```env
# Настройки приложения
APP_PORT=8082
APP_ENV=development

# Настройки MongoDB
MONGODB_URI=mongodb://localhost:27017
MONGODB_DB=chat_service

# Настройки Redis
REDIS_URI=redis://localhost:6379
REDIS_DB=0

# JWT настройки
JWT_SECRET=your_jwt_secret

# WebSocket настройки
WS_PING_INTERVAL=30s
WS_PONG_WAIT=60s
WS_WRITE_WAIT=10s
```

2. Запустите MongoDB и Redis:
```bash
# MongoDB
mongod --dbpath /path/to/data/db

# Redis
redis-server
```

## Структура проекта

```
chat-service/
├── cmd/                    # Точки входа
│   └── main.go            # Основной файл
├── config/                # Конфигурация
│   └── config.go         # Загрузка конфигурации
├── controllers/          # HTTP контроллеры
│   ├── chat.go          # Контроллер чатов
│   ├── message.go       # Контроллер сообщений
│   └── user.go          # Контроллер пользователей
├── database/            # Работа с БД
│   ├── mongodb.go      # MongoDB клиент
│   └── redis.go        # Redis клиент
├── middleware/          # Middleware функции
│   ├── auth.go         # Аутентификация
│   ├── logging.go      # Логирование
│   └── recovery.go     # Обработка паник
├── models/             # Модели данных
│   ├── chat.go        # Модель чата
│   ├── message.go     # Модель сообщения
│   └── user.go        # Модель пользователя
├── routes/            # Маршруты
│   └── routes.go      # Определение маршрутов
├── utils/             # Вспомогательные функции
│   ├── jwt.go        # JWT утилиты
│   └── validator.go  # Валидация
└── ws/               # WebSocket обработчики
    ├── hub.go       # WebSocket хаб
    └── handler.go   # Обработчики событий
```

## Разработка

### Запуск в режиме разработки
```bash
# Запуск с hot-reload
go run cmd/main.go

# Запуск с отладкой
dlv debug cmd/main.go
```

### Тестирование
```bash
# Запуск всех тестов
go test ./...

# Запуск тестов с покрытием
go test -cover ./...

# Запуск конкретного теста
go test ./controllers -run TestChatController
```

### Линтинг
```bash
# Запуск линтера
golangci-lint run

# Автоматическое исправление
golangci-lint run --fix
```

### Форматирование кода
```bash
# Форматирование всего проекта
go fmt ./...

# Форматирование конкретного файла
go fmt ./controllers/chat.go
```

## Стиль кода

### Общие правила
1. Используйте `gofmt` для форматирования кода
2. Следуйте [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)
3. Используйте `golangci-lint` для проверки кода

### Именование
1. Используйте camelCase для приватных переменных
2. Используйте PascalCase для публичных переменных и функций
3. Используйте короткие имена для локальных переменных
4. Используйте длинные имена для публичных API

### Документация
1. Документируйте все публичные функции и типы
2. Используйте [godoc](https://godoc.org/) формат
3. Добавляйте примеры использования

### Обработка ошибок
1. Всегда проверяйте ошибки
2. Используйте `errors.Wrap` для контекста
3. Логируйте ошибки с уровнем ERROR
4. Возвращайте понятные сообщения об ошибках

## Git Workflow

### Ветки
- `main` - основная ветка
- `develop` - ветка разработки
- `feature/*` - новые функции
- `bugfix/*` - исправления ошибок
- `hotfix/*` - срочные исправления

### Коммиты
1. Используйте [Conventional Commits](https://www.conventionalcommits.org/)
2. Пишите понятные сообщения
3. Связывайте с задачами в трекере

### Pull Requests
1. Создавайте PR в ветку `develop`
2. Добавляйте описание изменений
3. Указывайте связанные задачи
4. Запрашивайте ревью

## CI/CD

### GitHub Actions
1. Проверка кода
   - Линтинг
   - Тесты
   - Форматирование

2. Сборка
   - Сборка бинарника
   - Создание Docker образа
   - Публикация в registry

3. Деплой
   - Тестовое окружение
   - Продакшн окружение

## Отладка

### Логирование
1. Используйте структурированные логи
2. Указывайте контекст
3. Используйте уровни логирования
4. Добавляйте трейсинг

### Профилирование
1. Используйте `pprof`
2. Анализируйте память
3. Отслеживайте горутины
4. Мониторьте производительность

## Безопасность

### Код
1. Проверяйте входные данные
2. Используйте prepared statements
3. Валидируйте JWT токены
4. Защищайте от атак

### Конфигурация
1. Не храните секреты в коде
2. Используйте переменные окружения
3. Шифруйте чувствительные данные
4. Ограничивайте доступ

## Деплой

### Подготовка
1. Обновите версию
2. Обновите зависимости
3. Проведите тестирование
4. Подготовьте миграции

### Процесс
1. Соберите бинарник
2. Создайте Docker образ
3. Протестируйте в staging
4. Деплой в production

### Мониторинг
1. Проверьте логи
2. Мониторьте метрики
3. Проверьте алерты
4. Убедитесь в работоспособности 